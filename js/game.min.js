
var userId=0;var authKey="";var userData=null;var client=null;var clientObj=null;var lap=1;var stat={game:{pScore:0,cScore:0,pCardsThrow:0,pScoreThrow:0,cCardsThrow:0,cScoreThrow:0,minRoundScore:0,maxRoundScore:0,scoreDif:0},total:{gamesCount:0,win:0,lose:0,draw:0,minGameScore:0,maxGameScore:0,minGameScoreDif:0,maxGameScoreDif:0}};var gameContainer=null;var deckCounter={counter:52,el:null,dec:function(){this.counter--;this.el.text(this.counter)},reset:function(){this.counter=52}};var deck={el:null,cards:[],x:0,y:0};var cHand={el:null,cards:[],x:0,y:0,w:0,h:0,sort:function(){fitCards(this)}};var pHand={el:null,cards:[],x:0,y:0,w:0,h:0,sort:function(){this.cards=sortCards(this.cards);fitCards(this)}};var targetDeck1={el:null,cards:[],x:0,y:0,offset:{x:0,y:0},match:false,activate:function(){$("#target-deck-1").addClass("active")},disactivate:function(){$("#target-deck-1").removeClass("active")}};var targetDeck2={el:null,cards:[],x:0,y:0,offset:{x:0,y:0},match:false,activate:function(){$("#target-deck-2").addClass("active")},disactivate:function(){$("#target-deck-2").removeClass("active")}};var discard=[];$(document).ready(function(){gameContainer=$("#game-container");deckCounter.el=$("#deck-counter");deck.el=$("#deck");cHand.el=$("#c-hand");pHand.el=$("#p-hand");targetDeck1.el=$("#target-deck-1");targetDeck2.el=$("#target-deck-2");deck.x=parseInt(deck.el.css("left"));deck.y=parseInt(deck.el.css("top"));cHand.x=parseInt(cHand.el.css("left"));cHand.y=parseInt(cHand.el.css("top"));cHand.w=parseInt(cHand.el.width());cHand.h=parseInt(cHand.el.height());pHand.x=parseInt(pHand.el.css("left"));pHand.y=parseInt(pHand.el.css("top"));pHand.w=parseInt(pHand.el.width());pHand.h=parseInt(pHand.el.height());targetDeck1.x=parseInt(targetDeck1.el.css("left"));targetDeck1.y=parseInt(targetDeck1.el.css("top"));targetDeck1.offset.x=targetDeck1.x-CARD_WIDTH-CARD_PADDING;targetDeck1.offset.y=targetDeck1.y;targetDeck2.x=parseInt(targetDeck2.el.css("left"));targetDeck2.y=parseInt(targetDeck2.el.css("top"));targetDeck2.offset.x=targetDeck2.x+CARD_WIDTH+CARD_PADDING;targetDeck2.offset.y=targetDeck2.y;var a=0;setInterval(function(){$("#take-card-button-marker").css({"background-position-x":"-"+(a*26)+"px","margin-top":"-"+(a*3)+"px"});a<2?a++:a=0},200);$(".close-popup-button").click(function(){$("#"+$(this).data("popup-id")).css({display:"none"})});$(".open-popup-button").click(function(){$("#"+$(this).data("popup-id")).css({display:"block"})});var b=false;$(".help-button").click(function(){$("#help").css({display:"block"});if(!b){b=true;makeDragable("#help-scroll-bar-position",0,300,"#help-inner-scrollable",$("#help-inner-scrollable").outerHeight(true)-370,"","")}});$(".stat-button").click(function(){var c=$("#stat").css({display:"block"});c.find(".stat-games-count").text(stat.total.gamesCount);c.find(".stat-win").text(stat.total.win+(stat.total.gamesCount>0?" ("+Math.round(stat.total.win*100/stat.total.gamesCount)+"%)":""));c.find(".stat-lose").text(stat.total.lose);c.find(".stat-draw").text(stat.total.draw);c.find(".stat-min-game-score").text(stat.total.minGameScore);c.find(".stat-max-game-score").text(stat.total.maxGameScore);c.find(".stat-min-game-score-dif").text(stat.total.minGameScoreDif);c.find(".stat-max-game-score-dif").text(stat.total.maxGameScoreDif)});$(".rating-button").click(function(){$("#rating").css({display:"block"});loadRating()});$("#start-new-game-button").click(function(){$("#game-over").css({display:"none"});lap=1;stat.game.pScore=0;stat.game.cScore=0;stat.game.pCardsThrow=0;stat.game.pScoreThrow=0;stat.game.cCardsThrow=0;stat.game.cScoreThrow=0;stat.game.minRoundScore=0;stat.game.maxRoundScore=0;targetDeck1.disactivate();targetDeck2.disactivate();$("#score-table td.p-score").removeClass("text-green").removeClass("text-red").text("-");$("#score-table td.c-score").removeClass("text-green").removeClass("text-red").text("-");$("#score-table td.p-score-total").removeClass("text-green").removeClass("text-red").text("0");$("#score-table td.c-score-total").removeClass("text-green").removeClass("text-red").text("0");play()});$("#invite-friend-button").click(function(){VK.callMethod("showInviteBox")});$("#invite-friend-button2").click(function(){VK.callMethod("showInviteBox")});VK.init(function(){VK.api("users.get",{fields:"photo_50",v:"5.73"},function(c){userData=c;userId=c.response[0].id;authKey=getUrlParameter("auth_key");$(".p-name").text(c.response[0].first_name);$("#p-avatar").css({background:'url("'+c.response[0].photo_50+'") no-repeat'});loadData();play()})},function(){},"5.85")});function play(){deck.cards=[];cHand.cards=[];pHand.cards=[];targetDeck1.cards=[];targetDeck2.cards=[];discard=[];$(".card").remove();deckCounter.reset();var f=0;for(var g=1;g<5;g++){for(var l=1;l<14;l++){deck.cards[f]=new Card(l,g,gameContainer,deck.x,deck.y,f);f++}}deck.cards=shuffleArray(deck.cards);var e=cHand.x;var d=cHand.y;var k=pHand.x+pHand.w-CARD_WIDTH;var j=pHand.y;var b=1;var a=deck.cards.length-1;var h=a-HAND_MAX;for(f=a;f>h;f--){setTimeout(function(){deck.cards[f].position(e,d);deckCounter.dec();transfer(deck.cards,f,cHand.cards,false);e+=CARD_WIDTH+CARD_PADDING},DEFAULT_DELAY*b);b++}a-=h;h=a-HAND_MAX;for(f=a;f>h;f--){setTimeout(function(){deck.cards[f].position(k,j);deck.cards[f].show();deckCounter.dec();transfer(deck.cards,f,pHand.cards,false);k-=CARD_WIDTH+CARD_PADDING},DEFAULT_DELAY*b);b++}a-=h;setTimeout(function(){deck.cards[a].position(targetDeck2.x,targetDeck2.y);deck.cards[a].show();deckCounter.dec();transfer(deck.cards,a,targetDeck2.cards,false)},DEFAULT_DELAY*b);b++;a--;setTimeout(function(){deck.cards[a].position(targetDeck1.x,targetDeck1.y);deck.cards[a].show();deckCounter.dec();transfer(deck.cards,a,targetDeck1.cards,false)},DEFAULT_DELAY*b);b++;setTimeout("playerTurnDeck1();",DEFAULT_DELAY*b)}function playerTurnDeck1(){targetDeck1.activate();pHand.sort();var b=0;targetDeck1.match=false;for(var a=0;a<pHand.cards.length;a++){if(pHand.cards[a].match(targetDeck1.cards[targetDeck1.cards.length-1])){b++;pHand.cards[a].activate();pHand.cards[a].el.click(function(){targetDeck1.match=true;for(var c=0;c<pHand.cards.length;c++){pHand.cards[c].disactivate();pHand.cards[c].el.unbind("click")}var d=parseInt($(this).data("cid"));pHand.cards[d].position(targetDeck1.offset.x,targetDeck1.offset.y);transfer(pHand.cards,d,targetDeck1.cards);targetDeck1.disactivate();targetDeck2.activate();playerTurnDeck2();return false})}}if(b==0){if(deck.cards.length>0){$("#take-card-button").addClass("active").click(function(){$(this).removeClass("active").unbind("click");deck.cards[deck.cards.length-1].position(targetDeck1.offset.x,targetDeck1.offset.y);if(deck.cards[deck.cards.length-1].match(targetDeck1.cards[targetDeck1.cards.length-1])){targetDeck1.match=true}deckCounter.dec();transfer(deck.cards,deck.cards.length-1,targetDeck1.cards);targetDeck1.disactivate();targetDeck2.activate();playerTurnDeck2()})}else{roundOver()}}}function playerTurnDeck2(){pHand.sort();var b=0;targetDeck2.match=false;for(var a=0;a<pHand.cards.length;a++){if(pHand.cards[a].match(targetDeck2.cards[targetDeck2.cards.length-1])){b++;pHand.cards[a].activate();pHand.cards[a].el.click(function(){targetDeck1.cards[targetDeck1.cards.length-1].show();targetDeck2.match=true;for(var c=0;c<pHand.cards.length;c++){pHand.cards[c].disactivate();pHand.cards[c].el.unbind("click")}var d=parseInt($(this).data("cid"));pHand.cards[d].position(targetDeck2.offset.x,targetDeck2.offset.y);transfer(pHand.cards,d,targetDeck2.cards);targetDeck2.disactivate();pHand.sort();setTimeout("playerTurnConfirm();",DEFAULT_TIMEUOT);return false})}}if(b==0){if(deck.cards.length>0){$("#take-card-button").addClass("active").click(function(){$(this).removeClass("active").unbind("click");targetDeck1.cards[targetDeck1.cards.length-1].show();deck.cards[deck.cards.length-1].show();deck.cards[deck.cards.length-1].position(targetDeck2.offset.x,targetDeck2.offset.y);if(deck.cards[deck.cards.length-1].match(targetDeck2.cards[targetDeck2.cards.length-1])){targetDeck2.match=true}deckCounter.dec();transfer(deck.cards,deck.cards.length-1,targetDeck2.cards,false);targetDeck2.disactivate();pHand.sort();setTimeout("playerTurnConfirm();",DEFAULT_TIMEUOT)})}else{roundOver()}}}function playerTurnConfirm(){if(targetDeck1.match&&targetDeck2.match){stat.game.pCardsThrow++;stat.game.pScoreThrow+=targetDeck1.cards[targetDeck1.cards.length-1].value;targetDeck1.cards[targetDeck1.cards.length-1].position(targetDeck1.x,targetDeck1.y);stat.game.pCardsThrow++;stat.game.pScoreThrow+=targetDeck2.cards[targetDeck2.cards.length-1].value;targetDeck2.cards[targetDeck2.cards.length-1].position(targetDeck2.x,targetDeck2.y);var a=0;if(targetDeck1.cards[targetDeck1.cards.length-1].value==targetDeck1.cards[targetDeck1.cards.length-2].value){var c=targetDeck1.cards[targetDeck1.cards.length-1].value;for(a=0;a<pHand.cards.length;a++){if(pHand.cards[a].value==c){stat.game.pCardsThrow++;stat.game.pScoreThrow+=pHand.cards[a].value;pHand.cards[a].position(targetDeck1.x,targetDeck1.y);pHand.cards[a].remove();transfer(pHand.cards,a,discard)}}}if(targetDeck2.cards[targetDeck2.cards.length-1].value==targetDeck2.cards[targetDeck2.cards.length-2].value){var b=targetDeck2.cards[targetDeck2.cards.length-1].value;for(a=0;a<pHand.cards.length;a++){if(pHand.cards[a].value==b){stat.game.pCardsThrow++;stat.game.pScoreThrow+=pHand.cards[a].value;pHand.cards[a].position(targetDeck2.x,targetDeck2.y);pHand.cards[a].remove();transfer(pHand.cards,a,discard)}}}}else{transfer(targetDeck1.cards,targetDeck1.cards.length-1,pHand.cards);transfer(targetDeck2.cards,targetDeck2.cards.length-1,pHand.cards)}if(pHand.cards.length>0){pHand.sort();setTimeout("aiTurn();",DEFAULT_TIMEUOT)}else{roundOver()}}function aiTurn(){targetDeck1.match=false;targetDeck2.match=false;var a=0;for(a=0;a<cHand.cards.length;a++){if(cHand.cards[a].match(targetDeck1.cards[targetDeck1.cards.length-1])){cHand.cards[a].show();cHand.cards[a].position(targetDeck1.offset.x,targetDeck1.offset.y);transfer(cHand.cards,a,targetDeck1.cards);targetDeck1.match=true;break}}if(!targetDeck1.match){if(deck.cards.length>0){deck.cards[deck.cards.length-1].show();deck.cards[deck.cards.length-1].position(targetDeck1.offset.x,targetDeck1.offset.y);if(deck.cards[deck.cards.length-1].match(targetDeck1.cards[targetDeck1.cards.length-1])){targetDeck1.match=true}else{}deckCounter.dec();transfer(deck.cards,deck.cards.length-1,targetDeck1.cards)}else{setTimeout("roundOver();",DEFAULT_TIMEUOT);return}}for(a=0;a<cHand.cards.length;a++){if(cHand.cards[a].match(targetDeck2.cards[targetDeck2.cards.length-1])){cHand.cards[a].show();cHand.cards[a].position(targetDeck2.offset.x,targetDeck2.offset.y);transfer(cHand.cards,a,targetDeck2.cards);targetDeck2.match=true;break}}if(!targetDeck2.match){if(deck.cards.length>0){deck.cards[deck.cards.length-1].show();deck.cards[deck.cards.length-1].position(targetDeck2.offset.x,targetDeck2.offset.y);if(deck.cards[deck.cards.length-1].match(targetDeck2.cards[targetDeck2.cards.length-1])){targetDeck2.match=true}else{}deckCounter.dec();transfer(deck.cards,deck.cards.length-1,targetDeck2.cards)}else{setTimeout("roundOver();",DEFAULT_TIMEUOT);return}}if(targetDeck1.match&&targetDeck2.match){stat.game.cCardsThrow++;stat.game.cScoreThrow+=targetDeck1.cards[targetDeck1.cards.length-1].value;stat.game.cCardsThrow++;stat.game.cScoreThrow+=targetDeck2.cards[targetDeck2.cards.length-1].value;if(cHand.cards.length>0){cHand.sort();setTimeout("aiTurnStep2();",DEFAULT_TIMEUOT)}else{roundOver();return}}else{targetDeck1.cards[targetDeck1.cards.length-1].hide();transfer(targetDeck1.cards,targetDeck1.cards.length-1,cHand.cards);targetDeck2.cards[targetDeck2.cards.length-1].hide();transfer(targetDeck2.cards,targetDeck2.cards.length-1,cHand.cards);cHand.sort();setTimeout("playerTurnDeck1();",DEFAULT_TIMEUOT)}}function aiTurnStep2(){targetDeck1.cards[targetDeck1.cards.length-1].position(targetDeck1.x,targetDeck1.y);targetDeck2.cards[targetDeck2.cards.length-1].position(targetDeck2.x,targetDeck2.y);var a=0;var e=discard.length;if(targetDeck1.cards[targetDeck1.cards.length-1].value==targetDeck1.cards[targetDeck1.cards.length-2].value){var d=targetDeck1.cards[targetDeck1.cards.length-1].value;for(a=0;a<cHand.cards.length;a++){if(cHand.cards[a].value==d){stat.game.cCardsThrow++;stat.game.cScoreThrow+=cHand.cards[a].value;cHand.cards[a].position(targetDeck1.x,targetDeck1.y);cHand.cards[a].remove();transfer(cHand.cards,a,discard)}}}if(targetDeck2.cards[targetDeck2.cards.length-1].value==targetDeck2.cards[targetDeck2.cards.length-2].value){var b=targetDeck2.cards[targetDeck2.cards.length-1].value;for(a=0;a<cHand.cards.length;a++){if(cHand.cards[a].value==b){stat.game.cCardsThrow++;stat.game.cScoreThrow+=cHand.cards[a].value;cHand.cards[a].position(targetDeck2.x,targetDeck2.y);cHand.cards[a].remove();transfer(cHand.cards,a,discard)}}}if(e<discard.length){cHand.sort()}setTimeout("playerTurnDeck1();",DEFAULT_TIMEUOT)}function roundOver(){var c=0;var e=$("#score-table .lap"+lap);var a=e.find(".p-score");var f=e.find(".c-score");var b=0;var d=0;targetDeck1.disactivate();targetDeck2.disactivate();for(c=0;c<pHand.cards.length;c++){pHand.cards[c].disactivate();pHand.cards[c].el.unbind("click");b+=pHand.cards[c].value}stat.game.pScore+=b;if(lap==1){stat.game.minRoundScore=b;stat.game.maxRoundScore=b}else{if(stat.game.minRoundScore>b){stat.game.minRoundScore=b}if(stat.game.maxRoundScore<b){stat.game.maxRoundScore=b}}for(c=0;c<cHand.cards.length;c++){d+=cHand.cards[c].value}stat.game.cScore+=d;a.text(b);f.text(d);if(b<d){a.addClass("text-green");f.addClass("text-red")}if(d<b){f.addClass("text-green");a.addClass("text-red")}$(".p-score-total").text(stat.game.pScore).removeClass("text-green").removeClass("text-red");$(".c-score-total").text(stat.game.cScore).removeClass("text-green").removeClass("text-red");if(stat.game.pScore<stat.game.cScore){$(".p-score-total").addClass("text-green");$(".c-score-total").addClass("text-red")}if(stat.game.cScore<stat.game.pScore){$(".c-score-total").addClass("text-green");$(".p-score-total").addClass("text-red")}if(lap==7){gameOver()}else{lap++;play()}}function gameOver(){stat.total.gamesCount++;stat.game.scoreDif=stat.game.cScore-stat.game.pScore;if(stat.total.gamesCount==1){stat.total.minGameScore=stat.game.pScore;stat.total.maxGameScore=stat.game.pScore;stat.total.minGameScoreDif=stat.game.scoreDif;stat.total.maxGameScoreDif=stat.game.scoreDif}else{if(stat.total.minGameScore>stat.game.pScore){stat.total.minGameScore=stat.game.pScore}if(stat.total.maxGameScore<stat.game.pScore){stat.total.maxGameScore=stat.game.pScore}if(stat.total.minGameScoreDif>stat.game.scoreDif){stat.total.minGameScoreDif=stat.game.scoreDif}if(stat.total.maxGameScoreDif<stat.game.scoreDif){stat.total.maxGameScoreDif=stat.game.scoreDif}}var a=$("#game-over").css({display:"block"});if(stat.game.pScore>stat.game.cScore){a.find(".caption").removeClass("text-green").addClass("text-red").text("Поражение!");stat.total.lose++}else{if(stat.game.pScore<stat.game.cScore){a.find(".caption").removeClass("text-red").addClass("text-green").text("Победа!");stat.total.win++}else{a.find(".caption").removeClass("text-green").removeClass("text-red").text("Ничья!");stat.total.draw++}}a.find(".stat-p-score").text(stat.game.pScore);a.find(".stat-dif").text(stat.game.scoreDif);a.find(".stat-p-cards-throw").text(stat.game.pCardsThrow);a.find(".stat-p-score-throw").text(stat.game.pScoreThrow);a.find(".stat-c-cards-throw").text(stat.game.cCardsThrow);a.find(".stat-c-score-throw").text(stat.game.cScoreThrow);a.find(".stat-min-round-score").text(stat.game.minRoundScore);a.find(".stat-max-round-score").text(stat.game.maxRoundScore);a.find(".stat-average-round-score").text(Math.round(stat.game.pScore*10/lap)/10);a.find(".stat-games-count").text(stat.total.gamesCount);a.find(".stat-win").text(stat.total.win+" ("+Math.round(stat.total.win*100/stat.total.gamesCount)+"%)");a.find(".stat-lose").text(stat.total.lose);a.find(".stat-draw").text(stat.total.draw);saveData()}function saveData(){if(clientObj!=null){clientObj.id=userId;clientObj.g=stat.total.gamesCount;clientObj.w=stat.total.win;clientObj.l=stat.total.lose;clientObj.minS=stat.total.minGameScore;clientObj.maxS=stat.total.maxGameScore;clientObj.minSD=stat.total.minGameScoreDif;clientObj.maxSD=stat.total.maxGameScoreDif;clientObj.save()}}function loadData(){PlayerIO.useSecureApiRequests=true;PlayerIO.authenticate("seven-egjyt1hlt0yu1j5h6ggw","public",{userId:authKey},{},function(a){client=a;client.bigDB.loadOrCreate("data",authKey,function(b){clientObj=b;if(!clientObj.id){saveData()}else{stat.total.gamesCount=parseInt(clientObj.g);stat.total.win=parseInt(clientObj.w);stat.total.lose=parseInt(clientObj.l);stat.total.draw=stat.total.gamesCount-stat.total.win-stat.total.lose;stat.total.minGameScore=parseInt(clientObj.minS);stat.total.maxGameScore=parseInt(clientObj.maxS);stat.total.minGameScoreDif=parseInt(clientObj.minSD);stat.total.maxGameScoreDif=parseInt(clientObj.maxSD)}},function(b){})},function(a){})}function loadRating(){client.bigDB.loadRange("data","byMaxScore",null,null,null,10,function(c){var b=0;var e="";var a=false;var d="";for(b in c){d+=(d=="")?c[b].id:","+c[b].id}VK.api("users.get",{user_ids:d,fields:"photo_50",v:"5.73"},function(g){if(c!=null){e='<table style="width:100%">';e+="<tr>";e+="<td></td>";e+="<td></td>";e+="<td>Игр сыграно</td>";e+="<td>Побед</td>";e+="<td>Макс. очков за игру</td>";e+="</tr>";for(b in c){var f=false;if(c[b].id==userId){a=true;f=true}e+="<tr "+(f?'class="bold"':"")+">";e+="<td>"+(parseInt(b)+1)+"</td>";e+='<td style="text-align:left"><img width="25" src="'+g.response[b].photo_50+'" alt=""> '+g.response[b].first_name+"</td>";e+="<td>"+parseInt(c[b].g)+"</td>";e+="<td>"+parseInt(c[b].w)+(parseInt(c[b].g)>0?" ("+Math.round(parseInt(c[b].w)*100/parseInt(c[b].g))+"%)":"")+"</td>";e+="<td>"+parseInt(c[b].maxSD)+"</td>";e+="</tr>"}if(!a){e+='<tr class="bold">';e+="<td>--</td>";e+='<td style="text-align:left"><img width="25" src="'+userData.response[0].photo_50+'" alt=""> '+userData.response[0].first_name+"</td>";e+="<td>"+stat.total.gamesCount+"</td>";e+="<td>"+stat.total.win+(stat.total.win>0?" ("+Math.round(stat.total.win*100/stat.total.gamesCount)+"%)":"")+"</td>";e+="<td>"+stat.total.maxGameScoreDif+"</td>";e+="</tr>"}e+="</table>";$("#ratind-table-container").empty().append(e)}})},function(a){return null})};